name: CI

on:
  # 保留官方触发条件：指定分支的push、PR、手动触发
  push:
    branches: [ "main", "v2", "v3", "dev", "*-*" ]
  pull_request:
    branches: [ "main", "v2", "v3", "dev", "*-*" ]
  workflow_dispatch:
  # 新增：Release正式发布时触发（用于编译+上传产物）
  release:
    types: [published]

# 全局环境变量（解决OOM、统一Wails版本）
env:
  NODE_OPTIONS: "--max-old-space-size=4096"
  WAILS_VERSION: "v2.11.0"  # 统一官方指定的Wails版本

jobs:
  # ===================== Linux 系列 =====================
  ubuntu2404:
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive
      # 新增：克隆mcp-partner到项目根目录（官方步骤后、构建前）
      - name: Clone mcp-partner repository
        run: |
          git clone https://github.com/Ericwyn/mcp-partner.git ./mcp-partner
          rm -rf ./mcp-partner/node_modules ./mcp-partner/package-lock.json
          ls -la ./mcp-partner  # 验证克隆（可选，调试用）
        shell: bash
      - uses: dAppServer/wails-build-action@main
        id: build-ubuntu2404  # 新增ID，用于后续定位产物
        with:
          build-name: wails
          build-platform: linux/amd64
          wails-build-webview2: "embed"
          package: false # 保持官方配置：不自动上传
      # 新增：Release发布时，上传该产物到GitHub Release
      - name: Upload to Release (ubuntu2404)
        if: github.event_name == 'release' && github.event.action == 'published'
        uses: softprops/action-gh-release@v2
        with:
          files: ${{ steps.build-ubuntu2404.outputs.build-output-dir }}/wails
          tag_name: ${{ github.ref_name }}
          token: ${{ secrets.GITHUB_TOKEN }}
          overwrite: true
      # 新增：重命名并压缩编译产物（ubuntu2404）
      - name: Rename and zip build artifact (ubuntu2404)
        run: |
          SOURCE_FILE="${{ steps.build-ubuntu2404.outputs.build-output-dir }}/wails"
          TARGET_NAME="wails-ubuntu2404-amd64"
          zip "${TARGET_NAME}.zip" "$SOURCE_FILE"
        shell: bash
      # 新增：上传到GitHub Artifacts（保留7天）
      - name: Upload build artifact to Archive (ubuntu2404)
        uses: actions/upload-artifact@v4
        with:
          name: wails-ubuntu2404-amd64
          path: wails-ubuntu2404-amd64.zip
          retention-days: 7

  ubuntu2204:
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive
      # 新增：克隆mcp-partner
      - name: Clone mcp-partner repository
        run: |
          git clone https://github.com/Ericwyn/mcp-partner.git ./mcp-partner
          rm -rf ./mcp-partner/node_modules ./mcp-partner/package-lock.json
        shell: bash
      - uses: dAppServer/wails-build-action@main
        id: build-ubuntu2204
        with:
          build-name: wails
          build-platform: linux/amd64
          wails-build-webview2: "embed"
          package: false
      # 新增：Release上传
      - name: Upload to Release (ubuntu2204)
        if: github.event_name == 'release' && github.event.action == 'published'
        uses: softprops/action-gh-release@v2
        with:
          files: ${{ steps.build-ubuntu2204.outputs.build-output-dir }}/wails
          tag_name: ${{ github.ref_name }}
          token: ${{ secrets.GITHUB_TOKEN }}
          overwrite: true
      # 新增：重命名并压缩编译产物（ubuntu2204）
      - name: Rename and zip build artifact (ubuntu2204)
        run: |
          SOURCE_FILE="${{ steps.build-ubuntu2204.outputs.build-output-dir }}/wails"
          TARGET_NAME="wails-ubuntu2204-amd64"
          zip "${TARGET_NAME}.zip" "$SOURCE_FILE"
        shell: bash
      # 新增：上传到GitHub Artifacts（保留7天）
      - name: Upload build artifact to Archive (ubuntu2204)
        uses: actions/upload-artifact@v4
        with:
          name: wails-ubuntu2204-amd64
          path: wails-ubuntu2204-amd64.zip
          retention-days: 7

  # ===================== macOS 系列 =====================
  macos15arm64:
    runs-on: macos-15
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive
      # 新增：克隆mcp-partner
      - name: Clone mcp-partner repository
        run: |
          git clone https://github.com/Ericwyn/mcp-partner.git ./mcp-partner
          rm -rf ./mcp-partner/node_modules ./mcp-partner/package-lock.json
        shell: bash
      - uses: dAppServer/wails-build-action@main
        id: build-macos15arm64
        with:
          build-name: wails
          build-platform: darwin/universal
          sign: "false"
          wails-version: ${{ env.WAILS_VERSION }}  # 复用全局变量
          sign-macos-apple-password: ${{ secrets.APPLE_PASSWORD }}
          sign-macos-app-id: "Developer ID Application: Lethean LTD (W2DNA5L5DY)"
          sign-macos-app-cert: ${{ secrets.MAC_DEVELOPER_CERT }}
          sign-macos-app-cert-password: ${{ secrets.MAC_DEVELOPER_PASS }}
          sign-macos-installer-id: "Developer ID Installer: Lethean LTD (W2DNA5L5DY)"
          sign-macos-installer-cert: ${{ secrets.MAC_DEVELOPER_INSTALL_CERT }}
          sign-macos-installer-cert-password: ${{ secrets.MAC_DEVELOPER_INSTALL_PASS }}
          package: false
      # 新增：Release上传
      - name: Upload to Release (macos15arm64)
        if: github.event_name == 'release' && github.event.action == 'published'
        uses: softprops/action-gh-release@v2
        with:
          # 修正：指向实际生成的可执行文件路径
          files: ${{ steps.build-macos15arm64.outputs.build-output-dir }}/mcp-partner.app/Contents/MacOS/wails
          tag_name: ${{ github.ref_name }}
          token: ${{ secrets.GITHUB_TOKEN }}
          overwrite: true
          file_name: wails-macos15-universal
      # 新增：重命名并压缩编译产物（macos15arm64，修正路径）
      - name: Rename and zip build artifact (macos15arm64)
        run: |
          # 修正：指向实际生成的可执行文件（mcp-partner.app 而非 wails.app）
          SOURCE_FILE="${{ steps.build-macos15arm64.outputs.build-output-dir }}/mcp-partner.app/Contents/MacOS/wails"
          TARGET_NAME="wails-macos15-universal"
          # 复制可执行文件到根目录并重命名
          cp "$SOURCE_FILE" "$TARGET_NAME"
          # 压缩（macOS 下用 zip 兼容跨平台，避免 ditto 路径问题）
          zip "${TARGET_NAME}.zip" "$TARGET_NAME"
        shell: bash
      # 新增：上传到GitHub Artifacts（保留7天）
      - name: Upload build artifact to Archive (macos15arm64)
        uses: actions/upload-artifact@v4
        with:
          name: wails-macos15-universal
          path: wails-macos15-universal.zip
          retention-days: 7

  macos14arm64:
    runs-on: macos-14
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive
      # 新增：克隆mcp-partner
      - name: Clone mcp-partner repository
        run: |
          git clone https://github.com/Ericwyn/mcp-partner.git ./mcp-partner
          rm -rf ./mcp-partner/node_modules ./mcp-partner/package-lock.json
        shell: bash
      - uses: dAppServer/wails-build-action@main
        id: build-macos14arm64
        with:
          build-name: wails
          build-platform: darwin/universal
          sign: "false"
          wails-version: ${{ env.WAILS_VERSION }}
          sign-macos-apple-password: ${{ secrets.APPLE_PASSWORD }}
          sign-macos-app-id: "Developer ID Application: Lethean LTD (W2DNA5L5DY)"
          sign-macos-app-cert: ${{ secrets.MAC_DEVELOPER_CERT }}
          sign-macos-app-cert-password: ${{ secrets.MAC_DEVELOPER_PASS }}
          sign-macos-installer-id: "Developer ID Installer: Lethean LTD (W2DNA5L5DY)"
          sign-macos-installer-cert: ${{ secrets.MAC_DEVELOPER_INSTALL_CERT }}
          sign-macos-installer-cert-password: ${{ secrets.MAC_DEVELOPER_INSTALL_PASS }}
          package: false
      # 新增：Release上传
      - name: Upload to Release (macos14arm64)
        if: github.event_name == 'release' && github.event.action == 'published'
        uses: softprops/action-gh-release@v2
        with:
          # 修正：指向实际生成的可执行文件路径
          files: ${{ steps.build-macos14arm64.outputs.build-output-dir }}/mcp-partner.app/Contents/MacOS/wails
          tag_name: ${{ github.ref_name }}
          token: ${{ secrets.GITHUB_TOKEN }}
          overwrite: true
          file_name: wails-macos14-universal
      # 新增：重命名并压缩编译产物（macos14arm64，修正路径）
      - name: Rename and zip build artifact (macos14arm64)
        run: |
          # 修正：指向实际生成的可执行文件（mcp-partner.app 而非 wails.app）
          SOURCE_FILE="${{ steps.build-macos14arm64.outputs.build-output-dir }}/mcp-partner.app/Contents/MacOS/wails"
          TARGET_NAME="wails-macos14-universal"
          # 复制可执行文件到根目录并重命名
          cp "$SOURCE_FILE" "$TARGET_NAME"
          # 压缩（macOS 下用 zip 兼容跨平台，避免 ditto 路径问题）
          zip "${TARGET_NAME}.zip" "$TARGET_NAME"
        shell: bash
      # 新增：上传到GitHub Artifacts（保留7天）
      - name: Upload build artifact to Archive (macos14arm64)
        uses: actions/upload-artifact@v4
        with:
          name: wails-macos14-universal
          path: wails-macos14-universal.zip
          retention-days: 7

  # ===================== Windows 系列 =====================
  windows2025:
    runs-on: windows-2025
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive
      # 新增：克隆mcp-partner（Windows兼容bash）
      - name: Clone mcp-partner repository
        shell: bash
        run: |
          git clone https://github.com/Ericwyn/mcp-partner.git ./mcp-partner
          rm -rf ./mcp-partner/node_modules ./mcp-partner/package-lock.json
      - uses: dAppServer/wails-build-action@main
        id: build-windows2025
        with:
          build-name: wails.exe
          build-platform: windows/amd64
          wails-build-webview2: "embed"
          nsis: 'false'
          package: false
      # 新增：Release上传
      - name: Upload to Release (windows2025)
        if: github.event_name == 'release' && github.event.action == 'published'
        uses: softprops/action-gh-release@v2
        with:
          files: ${{ steps.build-windows2025.outputs.build-output-dir }}/wails.exe
          tag_name: ${{ github.ref_name }}
          token: ${{ secrets.GITHUB_TOKEN }}
          overwrite: true
          file_name: wails-windows2025.exe
      # 新增：重命名并压缩编译产物（windows2025）
      - name: Rename and zip build artifact (windows2025)
        run: |
          SOURCE_FILE="${{ steps.build-windows2025.outputs.build-output-dir }}/wails.exe"
          TARGET_NAME="wails-windows2025-amd64.exe"
          cp "$SOURCE_FILE" "$TARGET_NAME"
          zip "${TARGET_NAME}.zip" "$TARGET_NAME"
        shell: bash
      # 新增：上传到GitHub Artifacts（保留7天）
      - name: Upload build artifact to Archive (windows2025)
        uses: actions/upload-artifact@v4
        with:
          name: wails-windows2025-amd64
          path: wails-windows2025-amd64.exe.zip
          retention-days: 7

  windows2022:
    runs-on: windows-2022
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive
      # 新增：克隆mcp-partner
      - name: Clone mcp-partner repository
        shell: bash
        run: |
          git clone https://github.com/Ericwyn/mcp-partner.git ./mcp-partner
          rm -rf ./mcp-partner/node_modules ./mcp-partner/package-lock.json
      - uses: dAppServer/wails-build-action@main
        id: build-windows2022
        with:
          build-name: wails.exe
          build-platform: windows/amd64
          wails-build-webview2: "embed"
          nsis: 'false'
          package: false
      # 新增：Release上传
      - name: Upload to Release (windows2022)
        if: github.event_name == 'release' && github.event.action == 'published'
        uses: softprops/action-gh-release@v2
        with:
          files: ${{ steps.build-windows2022.outputs.build-output-dir }}/wails.exe
          tag_name: ${{ github.ref_name }}
          token: ${{ secrets.GITHUB_TOKEN }}
          overwrite: true
          file_name: wails-windows2022.exe
      # 新增：重命名并压缩编译产物（windows2022）
      - name: Rename and zip build artifact (windows2022)
        run: |
          SOURCE_FILE="${{ steps.build-windows2022.outputs.build-output-dir }}/wails.exe"
          TARGET_NAME="wails-windows2022-amd64.exe"
          cp "$SOURCE_FILE" "$TARGET_NAME"
          zip "${TARGET_NAME}.zip" "$TARGET_NAME"
        shell: bash
      # 新增：上传到GitHub Artifacts（保留7天）
      - name: Upload build artifact to Archive (windows2022)
        uses: actions/upload-artifact@v4
        with:
          name: wails-windows2022-amd64
          path: wails-windows2022-amd64.exe.zip
          retention-days: 7

  windows2019:
    runs-on: windows-2019
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive
      # 新增：克隆mcp-partner
      - name: Clone mcp-partner repository
        shell: bash
        run: |
          git clone https://github.com/Ericwyn/mcp-partner.git ./mcp-partner
          rm -rf ./mcp-partner/node_modules ./mcp-partner/package-lock.json
      - uses: dAppServer/wails-build-action@main
        id: build-windows2019
        with:
          build-name: wails.exe
          build-platform: windows/amd64
          wails-build-webview2: "embed"
          nsis: 'false'
          package: false
      # 新增：Release上传
      - name: Upload to Release (windows2019)
        if: github.event_name == 'release' && github.event.action == 'published'
        uses: softprops/action-gh-release@v2
        with:
          files: ${{ steps.build-windows2019.outputs.build-output-dir }}/wails.exe
          tag_name: ${{ github.ref_name }}
          token: ${{ secrets.GITHUB_TOKEN }}
          overwrite: true
          file_name: wails-windows2019.exe
      # 新增：重命名并压缩编译产物（windows2019）
      - name: Rename and zip build artifact (windows2019)
        run: |
          SOURCE_FILE="${{ steps.build-windows2019.outputs.build-output-dir }}/wails.exe"
          TARGET_NAME="wails-windows2019-amd64.exe"
          cp "$SOURCE_FILE" "$TARGET_NAME"
          zip "${TARGET_NAME}.zip" "$TARGET_NAME"
        shell: bash
      # 新增：上传到GitHub Artifacts（保留7天）
      - name: Upload build artifact to Archive (windows2019)
        uses: actions/upload-artifact@v4
        with:
          name: wails-windows2019-amd64
          path: wails-windows2019-amd64.exe.zip
          retention-days: 7

  windows-nsis:
    runs-on: windows-2022
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive
      # 新增：克隆mcp-partner
      - name: Clone mcp-partner repository
        shell: bash
        run: |
          git clone https://github.com/Ericwyn/mcp-partner.git ./mcp-partner
          rm -rf ./mcp-partner/node_modules ./mcp-partner/package-lock.json
      - uses: dAppServer/wails-build-action@main
        id: build-windows-nsis
        with:
          build-name: wails.exe
          build-platform: windows/amd64
          wails-build-webview2: "embed"
          nsis: "true"
          package: false
      # 新增：Release上传（NSIS安装包）
      - name: Upload to Release (windows-nsis)
        if: github.event_name == 'release' && github.event.action == 'published'
        uses: softprops/action-gh-release@v2
        with:
          # NSIS产物默认在build目录下，后缀为.exe安装包
          files: ${{ steps.build-windows-nsis.outputs.build-output-dir }}/*.exe
          tag_name: ${{ github.ref_name }}
          token: ${{ secrets.GITHUB_TOKEN }}
          overwrite: true
          file_name: wails-windows-installer.exe
      # 新增：重命名并压缩编译产物（windows-nsis）
      - name: Rename and zip build artifact (windows-nsis)
        run: |
          # 找到NSIS生成的安装包（排除原始wails.exe）
          SOURCE_FILE=$(ls ${{ steps.build-windows-nsis.outputs.build-output-dir }}/*.exe | grep -v wails.exe | head -n1)
          TARGET_NAME="wails-windows-installer.exe"
          cp "$SOURCE_FILE" "$TARGET_NAME"
          zip "${TARGET_NAME}.zip" "$TARGET_NAME"
        shell: bash
      # 新增：上传到GitHub Artifacts（保留7天）
      - name: Upload build artifact to Archive (windows-nsis)
        uses: actions/upload-artifact@v4
        with:
          name: wails-windows-installer
          path: wails-windows-installer.exe.zip
          retention-days: 7
