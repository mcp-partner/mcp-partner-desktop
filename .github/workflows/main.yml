name: Wails Build & Release

# 触发条件：所有push + Release发布
on:
  push:
    branches: ['*']  # 所有分支push触发编译
    tags: ['*']      # 兼容tag推送
  release:
    types: [published]  # Release正式发布时触发编译+上传

env:
  NODE_OPTIONS: "--max-old-space-size=4096"
  WAILS_VERSION: "v2.8.0"  # 指定Wails版本（可根据需求调整）

jobs:
  build:
    strategy:
      fail-fast: false
      matrix:
        build:
          - name: Linux
            platform: linux/amd64
            os: ubuntu-latest
            output_name: app-linux-amd64
            build_flags: ""
          - name: Windows
            platform: windows/amd64
            os: windows-latest
            output_name: app-windows-amd64.exe
            build_flags: ""
          - name: macOS
            platform: darwin/universal
            os: macos-latest
            output_name: app-macos-universal
            build_flags: "-universal"

    runs-on: ${{ matrix.build.os }}
    steps:
      # 1. 检出主项目（最新v4版本）
      - name: Checkout main project
        uses: actions/checkout@v4
        with:
          submodules: recursive
          path: .

      # 2. 克隆mcp-partner依赖
      - name: Clone mcp-partner repository
        run: |
          git clone https://github.com/Ericwyn/mcp-partner.git ./mcp-partner
          ls -la ./mcp-partner
        shell: bash

      # 3. 安装Go（最新稳定版，匹配Wails要求）
      - name: Set up Go
        uses: actions/setup-go@v5  # 升级到v5（最新版）
        with:
          go-version: '1.22'
          cache: true  # 开启Go模块缓存，加速构建

      # 4. 安装Node.js（Wails前端构建依赖）
      - name: Set up Node.js
        uses: actions/setup-node@v4  # 升级到v4（最新版）
        with:
          node-version: '20'  # LTS版本，兼容大多数项目
          cache: 'npm'  # 开启npm缓存

      # 5. 安装Wails CLI（手动安装，避免第三方Action依赖）
      - name: Install Wails CLI
        run: |
          go install github.com/wailsapp/wails/v2/cmd/wails@${{ env.WAILS_VERSION }}
          wails version
        shell: bash

      # 6. 安装系统依赖（不同平台按需安装）
      - name: Install system dependencies (Linux)
        if: matrix.build.os == 'ubuntu-latest'
        run: |
          sudo apt-get update
          sudo apt-get install -y libgtk-3-dev libwebkit2gtk-4.0-dev libappindicator3-dev librsvg2-dev patchelf
        shell: bash

      - name: Install system dependencies (macOS)
        if: matrix.build.os == 'macos-latest'
        run: |
          brew install webkit2gtk
        shell: bash

      # 7. 构建Wails应用（核心步骤，手动执行）
      - name: Build Wails application
        run: |
          # 前端依赖安装
          npm install
          # Wails构建（指定输出名称和平台）
          wails build -platform ${{ matrix.build.platform }} -output ./build/${{ matrix.build.output_name }} ${{ matrix.build.build_flags }}
        shell: bash
        working-directory: .

      # 8. 上传构建产物为Artifact（可选，方便查看push后的编译结果）
      - name: Upload build artifact
        uses: actions/upload-artifact@v4  # 升级到v4（最新版，解决报错核心）
        with:
          name: ${{ matrix.build.output_name }}
          path: ./build/${{ matrix.build.output_name }}
          retention-days: 7  # 产物保留7天（可选）

      # 9. 上传产物到GitHub Release（仅Release发布时执行）
      - name: Upload to GitHub Release
        if: github.event_name == 'release' && github.event.action == 'published'
        uses: softprops/action-gh-release@v2
        with:
          files: ./build/${{ matrix.build.output_name }}
          tag_name: ${{ github.ref_name }}
          token: ${{ secrets.GITHUB_TOKEN }}
          overwrite: true  # 覆盖同名产物（可选）