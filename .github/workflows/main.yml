name: CI

on:
  push:
    branches: [ "main", "v2", "v3", "dev", "*-*" ]
  pull_request:
    branches: [ "main", "v2", "v3", "dev", "*-*" ]
  workflow_dispatch:
  release:
    types: [published]

env:
  NODE_OPTIONS: "--max-old-space-size=4096"
  WAILS_VERSION: "v2.11.0"

jobs:
  build:
    name: Build ${{ matrix.id }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          # Linux Builds
          - id: ubuntu2404
            os: ubuntu-24.04
            platform: linux/amd64
            nsis: 'false'
            binary_name: wails
            artifact_name: mcp-partner-ubuntu2404-amd64

          - id: ubuntu2204
            os: ubuntu-22.04
            platform: linux/amd64
            nsis: 'false'
            binary_name: wails
            artifact_name: mcp-partner-ubuntu2204-amd64

          # Windows Builds
          - id: windows2025
            os: windows-2025
            platform: windows/amd64
            nsis: 'false'
            binary_name: wails.exe
            artifact_name: mcp-partner-windows2025-amd64.exe

          - id: windows2022
            os: windows-2022
            platform: windows/amd64
            nsis: 'false'
            binary_name: wails.exe
            artifact_name: mcp-partner-windows2022-amd64.exe

          - id: windows2019
            os: windows-2019
            platform: windows/amd64
            nsis: 'false'
            binary_name: wails.exe
            artifact_name: mcp-partner-windows2019-amd64.exe

          # Windows Installer Build (NSIS)
          - id: windows-nsis
            os: windows-2022
            platform: windows/amd64
            nsis: 'true'
            binary_name: installer
            artifact_name: mcp-partner-windows-installer.exe

          # MacOS Build (Universal: Arm64 + Amd64)
          - id: macos-universal
            os: macos-latest
            platform: darwin/universal
            nsis: 'false'
            binary_name: mcp-partner
            # 最终生成的构件名称，加上 .app 后缀以便系统识别
            artifact_name: mcp-partner-macos-universal.app

    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Clone mcp-partner repository
        shell: bash
        run: |
          git clone https://github.com/mcp-partner/mcp-partner.github.io.git ./mcp-partner
          rm -rf ./mcp-partner/node_modules ./mcp-partner/package-lock.json

      - uses: dAppServer/wails-build-action@main
        id: build-wails
        with:
          build-name: ${{ matrix.binary_name }}
          build-platform: ${{ matrix.platform }}
          wails-build-webview2: "embed"
          nsis: ${{ matrix.nsis }}
          package: false
          # MacOS 签名配置 (目前设为 false，如需签名需配置 secrets)
          sign: "false"

      - name: Rename build artifact
        shell: bash
        run: |
          TARGET_NAME="${{ matrix.artifact_name }}"
          
          if [ "${{ runner.os }}" == "macOS" ]; then
            # MacOS 逻辑: 查找生成的 .app 文件夹
            # Wails 在 darwin 平台通常生成一个 .app bundle
            SOURCE_FILE=$(find build/bin -type d -name "*.app" | head -n1)
            echo "Found MacOS Bundle: $SOURCE_FILE"
          elif [ "${{ matrix.nsis }}" == "true" ]; then
            # Windows NSIS 逻辑
            SOURCE_FILE=$(ls ${{ steps.build-wails.outputs.build-output-dir }}/*.exe | grep -v wails.exe | head -n1)
          else
            # 标准 Linux/Windows 单文件逻辑
            SOURCE_FILE="build/bin/${{ matrix.binary_name }}"
          fi
          
          echo "Copying $SOURCE_FILE to $TARGET_NAME"
          # 使用 -r 以支持 macOS .app 文件夹的复制
          cp -r "$SOURCE_FILE" "$TARGET_NAME"

      - name: Upload build artifact to Archive
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact_name }}
          path: ${{ matrix.artifact_name }}
          retention-days: 7

      # Compression - Unified Logic

      - name: Compress for Release (Linux & MacOS)
        # 修改：同时匹配 Linux 和 macOS
        if: github.event_name == 'release' && github.event.action == 'published' && (runner.os == 'Linux' || runner.os == 'macOS')
        run: |
          # 如果是 macOS .app 文件夹，zip 会递归压缩保留目录结构
          # -r 参数确保递归压缩文件夹
          zip -r "${{ matrix.artifact_name }}.zip" "${{ matrix.artifact_name }}"
        shell: bash

      - name: Compress for Release (Windows)
        if: github.event_name == 'release' && github.event.action == 'published' && runner.os == 'Windows'
        run: |
          pwsh -Command "Compress-Archive -Path '${{ matrix.artifact_name }}' -DestinationPath '${{ matrix.artifact_name }}.zip' -Force"
        shell: bash

      - name: Upload to Release
        if: github.event_name == 'release' && github.event.action == 'published'
        uses: softprops/action-gh-release@v2
        with:
          files: ${{ matrix.artifact_name }}.zip
          tag_name: ${{ github.ref_name }}
          token: ${{ secrets.GITHUB_TOKEN }}
          overwrite: true
          file_name: ${{ matrix.artifact_name }}.zip