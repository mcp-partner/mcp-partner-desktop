name: CI

on:
  push:
    branches: [ "main", "v2", "v3", "dev", "*-*" ]
  pull_request:
    branches: [ "main", "v2", "v3", "dev", "*-*" ]
  workflow_dispatch:
  release:
    types: [published]

env:
  NODE_OPTIONS: "--max-old-space-size=4096"
  WAILS_VERSION: "v2.11.0"

jobs:
  ubuntu2404:
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive
      - name: Clone mcp-partner repository
        run: |
          git clone https://github.com/Ericwyn/mcp-partner.git ./mcp-partner
          rm -rf ./mcp-partner/node_modules ./mcp-partner/package-lock.json
        shell: bash
      - uses: dAppServer/wails-build-action@main
        id: build-ubuntu2404
        with:
          build-name: wails
          build-platform: linux/amd64
          wails-build-webview2: "embed"
          package: false
      - name: Rename build artifact (ubuntu2404)
        run: |
          SOURCE_FILE="build/bin/wails"
          TARGET_NAME="wails-ubuntu2404-amd64"
          cp "$SOURCE_FILE" "$TARGET_NAME"
        shell: bash
      - name: Upload build artifact to Archive (ubuntu2404)
        uses: actions/upload-artifact@v4
        with:
          name: wails-ubuntu2404-amd64
          path: wails-ubuntu2404-amd64
          retention-days: 7
      - name: Compress for Release (ubuntu2404)
        if: github.event_name == 'release' && github.event.action == 'published'
        run: |
          zip "wails-ubuntu2404-amd64.zip" "wails-ubuntu2404-amd64"
        shell: bash
      - name: Upload to Release (ubuntu2404)
        if: github.event_name == 'release' && github.event.action == 'published'
        uses: softprops/action-gh-release@v2
        with:
          files: wails-ubuntu2404-amd64.zip
          tag_name: ${{ github.ref_name }}
          token: ${{ secrets.GITHUB_TOKEN }}
          overwrite: true
          file_name: wails-ubuntu2404-amd64.zip

  ubuntu2204:
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive
      - name: Clone mcp-partner repository
        run: |
          git clone https://github.com/Ericwyn/mcp-partner.git ./mcp-partner
          rm -rf ./mcp-partner/node_modules ./mcp-partner/package-lock.json
        shell: bash
      - uses: dAppServer/wails-build-action@main
        id: build-ubuntu2204
        with:
          build-name: wails
          build-platform: linux/amd64
          wails-build-webview2: "embed"
          package: false
      - name: Rename build artifact (ubuntu2204)
        run: |
          SOURCE_FILE="build/bin/wails"
          TARGET_NAME="wails-ubuntu2204-amd64"
          cp "$SOURCE_FILE" "$TARGET_NAME"
        shell: bash
      - name: Upload build artifact to Archive (ubuntu2204)
        uses: actions/upload-artifact@v4
        with:
          name: wails-ubuntu2204-amd64
          path: wails-ubuntu2204-amd64
          retention-days: 7
      - name: Compress for Release (ubuntu2204)
        if: github.event_name == 'release' && github.event.action == 'published'
        run: |
          zip "wails-ubuntu2204-amd64.zip" "wails-ubuntu2204-amd64"
        shell: bash
      - name: Upload to Release (ubuntu2204)
        if: github.event_name == 'release' && github.event.action == 'published'
        uses: softprops/action-gh-release@v2
        with:
          files: wails-ubuntu2204-amd64.zip
          tag_name: ${{ github.ref_name }}
          token: ${{ secrets.GITHUB_TOKEN }}
          overwrite: true
          file_name: wails-ubuntu2204-amd64.zip

  # macos15arm64:
  #   runs-on: macos-15
  #   steps:
  #     - uses: actions/checkout@v4
  #       with:
  #         submodules: recursive
  #     - name: Clone mcp-partner repository
  #       run: |
  #         git clone https://github.com/Ericwyn/mcp-partner.git ./mcp-partner
  #         rm -rf ./mcp-partner/node_modules ./mcp-partner/package-lock.json
  #       shell: bash
  #     - uses: dAppServer/wails-build-action@main
  #       id: build-macos15arm64
  #       with:
  #         build-name: wails
  #         build-platform: darwin/universal
  #         sign: "false"
  #         wails-version: ${{ env.WAILS_VERSION }}
  #         sign-macos-apple-password: ${{ secrets.APPLE_PASSWORD }}
  #         sign-macos-app-id: "Developer ID Application: Lethean LTD (W2DNA5L5DY)"
  #         sign-macos-app-cert: ${{ secrets.MAC_DEVELOPER_CERT }}
  #         sign-macos-app-cert-password: ${{ secrets.MAC_DEVELOPER_PASS }}
  #         sign-macos-installer-id: "Developer ID Installer: Lethean LTD (W2DNA5L5DY)"
  #         sign-macos-installer-cert: ${{ secrets.MAC_DEVELOPER_INSTALL_CERT }}
  #         sign-macos-installer-cert-password: ${{ secrets.MAC_DEVELOPER_INSTALL_PASS }}
  #         package: "false"
  #     - name: Rename build artifact (macos15arm64)
  #       run: |
  #         SOURCE_EXEC="${{ steps.build-macos15arm64.outputs.build-output-dir }}/mcp-partner.app/Contents/MacOS/wails"
  #         TARGET_EXEC="wails-macos15-universal"
  #         cp "$SOURCE_EXEC" "$TARGET_EXEC"
  #       shell: bash
  #     - name: Upload build artifact to Archive (macos15arm64)
  #       uses: actions/upload-artifact@v4
  #       with:
  #         name: wails-macos15-universal
  #         path: wails-macos15-universal
  #         retention-days: 7
  #     - name: Compress for Release (macos15arm64)
  #       if: github.event_name == 'release' && github.event.action == 'published'
  #       run: |
  #         zip "wails-macos15-universal.zip" "wails-macos15-universal"
  #       shell: bash
  #     - name: Upload to Release (macos15arm64)
  #       if: github.event_name == 'release' && github.event.action == 'published'
  #       uses: softprops/action-gh-release@v2
  #       with:
  #         files: wails-macos15-universal.zip
  #         tag_name: ${{ github.ref_name }}
  #         token: ${{ secrets.GITHUB_TOKEN }}
  #         overwrite: true
  #         file_name: wails-macos15-universal.zip

  # macos14arm64:
  #   runs-on: macos-14
  #   steps:
  #     - uses: actions/checkout@v4
  #       with:
  #         submodules: recursive
  #     - name: Clone mcp-partner repository
  #       run: |
  #         git clone https://github.com/Ericwyn/mcp-partner.git ./mcp-partner
  #         rm -rf ./mcp-partner/node_modules ./mcp-partner/package-lock.json
  #       shell: bash
  #     - uses: dAppServer/wails-build-action@main
  #       id: build-macos14arm64
  #       with:
  #         build-name: wails
  #         build-platform: darwin/universal
  #         sign: "false"
  #         wails-version: ${{ env.WAILS_VERSION }}
  #         sign-macos-apple-password: ${{ secrets.APPLE_PASSWORD }}
  #         sign-macos-app-id: "Developer ID Application: Lethean LTD (W2DNA5L5DY)"
  #         sign-macos-app-cert: ${{ secrets.MAC_DEVELOPER_CERT }}
  #         sign-macos-app-cert-password: ${{ secrets.MAC_DEVELOPER_PASS }}
  #         sign-macos-installer-id: "Developer ID Installer: Lethean LTD (W2DNA5L5DY)"
  #         sign-macos-installer-cert: ${{ secrets.MAC_DEVELOPER_INSTALL_CERT }}
  #         sign-macos-installer-cert-password: ${{ secrets.MAC_DEVELOPER_INSTALL_PASS }}
  #         package: "false"
  #     - name: Rename build artifact (macos14arm64)
  #       run: |
  #         SOURCE_EXEC="${{ steps.build-macos14arm64.outputs.build-output-dir }}/mcp-partner.app/Contents/MacOS/wails"
  #         TARGET_EXEC="wails-macos14-universal"
  #         cp "$SOURCE_EXEC" "$TARGET_EXEC"
  #       shell: bash
  #     - name: Upload build artifact to Archive (macos14arm64)
  #       uses: actions/upload-artifact@v4
  #       with:
  #         name: wails-macos14-universal
  #         path: wails-macos14-universal
  #         retention-days: 7
  #     - name: Compress for Release (macos14arm64)
  #       if: github.event_name == 'release' && github.event.action == 'published'
  #       run: |
  #         zip "wails-macos14-universal.zip" "wails-macos14-universal"
  #       shell: bash
  #     - name: Upload to Release (macos14arm64)
  #       if: github.event_name == 'release' && github.event.action == 'published'
  #       uses: softprops/action-gh-release@v2
  #       with:
  #         files: wails-macos14-universal.zip
  #         tag_name: ${{ github.ref_name }}
  #         token: ${{ secrets.GITHUB_TOKEN }}
  #         overwrite: true
  #         file_name: wails-macos14-universal.zip

  windows2025:
    runs-on: windows-2025
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive
      - name: Clone mcp-partner repository
        shell: bash
        run: |
          git clone https://github.com/Ericwyn/mcp-partner.git ./mcp-partner
          rm -rf ./mcp-partner/node_modules ./mcp-partner/package-lock.json
      - uses: dAppServer/wails-build-action@main
        id: build-windows2025
        with:
          build-name: wails.exe
          build-platform: windows/amd64
          wails-build-webview2: "embed"
          nsis: 'false'
          package: false
      - name: Rename build artifact (windows2025)
        run: |
          SOURCE_FILE="build/bin/wails.exe"
          TARGET_NAME="wails-windows2025-amd64.exe"
          cp "$SOURCE_FILE" "$TARGET_NAME"
        shell: bash
      - name: Upload build artifact to Archive (windows2025)
        uses: actions/upload-artifact@v4
        with:
          name: wails-windows2025-amd64
          path: wails-windows2025-amd64.exe
          retention-days: 7
      - name: Compress for Release (windows2025)
        if: github.event_name == 'release' && github.event.action == 'published'
        run: |
          pwsh -Command "Compress-Archive -Path 'wails-windows2025-amd64.exe' -DestinationPath 'wails-windows2025-amd64.exe.zip' -Force"
        shell: bash
      - name: Upload to Release (windows2025)
        if: github.event_name == 'release' && github.event.action == 'published'
        uses: softprops/action-gh-release@v2
        with:
          files: wails-windows2025-amd64.exe.zip
          tag_name: ${{ github.ref_name }}
          token: ${{ secrets.GITHUB_TOKEN }}
          overwrite: true
          file_name: wails-windows2025-amd64.exe.zip

  windows2022:
    runs-on: windows-2022
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive
      - name: Clone mcp-partner repository
        shell: bash
        run: |
          git clone https://github.com/Ericwyn/mcp-partner.git ./mcp-partner
          rm -rf ./mcp-partner/node_modules ./mcp-partner/package-lock.json
      - uses: dAppServer/wails-build-action@main
        id: build-windows2022
        with:
          build-name: wails.exe
          build-platform: windows/amd64
          wails-build-webview2: "embed"
          nsis: 'false'
          package: false
      - name: Rename build artifact (windows2022)
        run: |
          SOURCE_FILE="build/bin/wails.exe"
          TARGET_NAME="wails-windows2022-amd64.exe"
          cp "$SOURCE_FILE" "$TARGET_NAME"
        shell: bash
      - name: Upload build artifact to Archive (windows2022)
        uses: actions/upload-artifact@v4
        with:
          name: wails-windows2022-amd64
          path: wails-windows2022-amd64.exe
          retention-days: 7
      - name: Compress for Release (windows2022)
        if: github.event_name == 'release' && github.event.action == 'published'
        run: |
          pwsh -Command "Compress-Archive -Path 'wails-windows2022-amd64.exe' -DestinationPath 'wails-windows2022-amd64.exe.zip' -Force"
        shell: bash
      - name: Upload to Release (windows2022)
        if: github.event_name == 'release' && github.event.action == 'published'
        uses: softprops/action-gh-release@v2
        with:
          files: wails-windows2022-amd64.exe.zip
          tag_name: ${{ github.ref_name }}
          token: ${{ secrets.GITHUB_TOKEN }}
          overwrite: true
          file_name: wails-windows2022-amd64.exe.zip

  windows2019:
    runs-on: windows-2019
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive
      - name: Clone mcp-partner repository
        shell: bash
        run: |
          git clone https://github.com/Ericwyn/mcp-partner.git ./mcp-partner
          rm -rf ./mcp-partner/node_modules ./mcp-partner/package-lock.json
      - uses: dAppServer/wails-build-action@main
        id: build-windows2019
        with:
          build-name: wails.exe
          build-platform: windows/amd64
          wails-build-webview2: "embed"
          nsis: 'false'
          package: false
      - name: Rename build artifact (windows2019)
        run: |
          SOURCE_FILE="build/bin/wails.exe"
          TARGET_NAME="wails-windows2019-amd64.exe"
          cp "$SOURCE_FILE" "$TARGET_NAME"
        shell: bash
      - name: Upload build artifact to Archive (windows2019)
        uses: actions/upload-artifact@v4
        with:
          name: wails-windows2019-amd64
          path: wails-windows2019-amd64.exe
          retention-days: 7
      - name: Compress for Release (windows2019)
        if: github.event_name == 'release' && github.event.action == 'published'
        run: |
          pwsh -Command "Compress-Archive -Path 'wails-windows2019-amd64.exe' -DestinationPath 'wails-windows2019-amd64.exe.zip' -Force"
        shell: bash
      - name: Upload to Release (windows2019)
        if: github.event_name == 'release' && github.event.action == 'published'
        uses: softprops/action-gh-release@v2
        with:
          files: wails-windows2019-amd64.exe.zip
          tag_name: ${{ github.ref_name }}
          token: ${{ secrets.GITHUB_TOKEN }}
          overwrite: true
          file_name: wails-windows2019-amd64.exe.zip

  windows-nsis:
    runs-on: windows-2022
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive
      - name: Clone mcp-partner repository
        shell: bash
        run: |
          git clone https://github.com/Ericwyn/mcp-partner.git ./mcp-partner
          rm -rf ./mcp-partner/node_modules ./mcp-partner/package-lock.json
      - uses: dAppServer/wails-build-action@main
        id: build-windows-nsis
        with:
          build-name: wails.exe
          build-platform: windows/amd64
          wails-build-webview2: "embed"
          nsis: "true"
          package: false
      - name: Rename build artifact (windows-nsis)
        run: |
          SOURCE_FILE=$(ls ${{ steps.build-windows-nsis.outputs.build-output-dir }}/*.exe | grep -v wails.exe | head -n1)
          TARGET_NAME="wails-windows-installer.exe"
          cp "$SOURCE_FILE" "$TARGET_NAME"
        shell: bash
      - name: Upload build artifact to Archive (windows-nsis)
        uses: actions/upload-artifact@v4
        with:
          name: wails-windows-installer
          path: wails-windows-installer.exe
          retention-days: 7
      - name: Compress for Release (windows-nsis)
        if: github.event_name == 'release' && github.event.action == 'published'
        run: |
          pwsh -Command "Compress-Archive -Path 'wails-windows-installer.exe' -DestinationPath 'wails-windows-installer.exe.zip' -Force"
        shell: bash
      - name: Upload to Release (windows-nsis)
        if: github.event_name == 'release' && github.event.action == 'published'
        uses: softprops/action-gh-release@v2
        with:
          files: wails-windows-installer.exe.zip
          tag_name: ${{ github.ref_name }}
          token: ${{ secrets.GITHUB_TOKEN }}
          overwrite: true
          file_name: wails-windows-installer.exe.zip
